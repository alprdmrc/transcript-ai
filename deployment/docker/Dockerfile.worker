FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PYTHONPATH=/app

RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg git curl ca-certificates && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY requirements-worker.txt ./
RUN pip install -U pip && pip install -r requirements-worker.txt

COPY app/ app/
COPY worker/ worker/
COPY dbmigrations/ dbmigrations/
COPY alembic.ini alembic.ini

# Start Celery worker
CMD ["celery", "-A", "worker.celery_app", "worker", "-l", "INFO", "--concurrency=1"]